# -*- text -*-
##
## SQL module configuration for FreeRADIUS with PostgreSQL
## This configuration uses environment variables to connect to the database
##

######################################################################
#
#  Configuration for the SQL module
#

sql {
	#
	#  The dialect of SQL being used.
	#
	dialect = "postgresql"

	#
	#  The driver module used to execute the queries.
	#
	driver = "rlm_sql_${dialect}"

	#
	#  Driver-specific subsections.
	#
	postgresql {
		# Send application_name to the postgres server
		# Only supported in PG 9.0 and greater. Defaults to no.
		send_application_name = yes
	}

	# Connection info:
	#
	server = "${env:DB_HOST}"
	port = ${env:DB_PORT}
	login = "${env:DB_USER}"
	password = "${env:DB_PASSWORD}"

	# Database table configuration
	radius_db = "${env:DB_NAME}"

	# Tables configuration
	acct_table1 = "radacct"
	acct_table2 = "radacct"

	# Allow for storing data after authentication
	postauth_table = "radpostauth"

	# Tables containing 'check' items
	authcheck_table = "radcheck"
	groupcheck_table = "radgroupcheck"

	# Tables containing 'reply' items
	authreply_table = "radreply"
	groupreply_table = "radgroupreply"

	# Table to keep group info
	usergroup_table = "radusergroup"

	# Remove stale session if checkrad does not see a double login
	delete_stale_sessions = yes

	# Read database-specific queries from the standard FreeRADIUS config
	$INCLUDE ${modconfdir}/sql/main/postgresql/queries.conf

	#
	# The group attribute specific to this instance of rlm_sql
	#
	group_attribute = "SQL-Group"

	#
	#  The connection pool is used to pool outgoing connections.
	#
	pool {
		#  Connections to create during module instantiation.
		start = 5

		#  Minimum number of connections to keep open
		min = 4

		#  Maximum number of connections
		max = 10

		#  Spare connections to be left idle
		spare = 3

		#  Number of uses before the connection is closed
		uses = 0

		#  The number of seconds to wait after the server tries
		#  to open a connection, and fails.  During this time,
		#  no new connections will be opened.
		retry_delay = 30

		# The lifetime (in seconds) of the connection
		lifetime = 0

		#  idle timeout (in seconds).  A connection which is
		#  unused for this length of time will be closed.
		idle_timeout = 60

		#  Maximum number of times an operation can be retried
		max_retries = 5
	}

	# Read radius clients from the database ('nas' table)
	# Disabled temporarily to avoid config validation issues
	read_clients = no

	# Table to keep radius client info
	client_table = "nas"
}
