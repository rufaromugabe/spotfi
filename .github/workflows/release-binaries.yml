name: Build and Release Binaries

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v1.2.3, etc.
  workflow_dispatch:  # Allow manual triggering
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases and upload assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Install UPX
        run: |
          sudo apt-get update
          sudo apt-get install -y upx-ucl
      
      - name: Build all architectures
        working-directory: ./spotfi-bridge-go
        run: |
          chmod +x build.sh
          # Build without UPX compression to avoid compatibility issues
          SKIP_UPX_COMPRESSION=true ./build.sh
      
      - name: Get version from tag or input
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building release: $VERSION"
      
      - name: Create release archive
        working-directory: ./spotfi-bridge-go
        run: |
          mkdir -p release
          cp spotfi-bridge-* release/ 2>/dev/null || true
          cd release
          tar -czf ../spotfi-bridge-binaries.tar.gz spotfi-bridge-* 2>/dev/null || true
          cd ..
          ls -lh spotfi-bridge-* release/ || true
      
      - name: Prepare binaries for release
        run: |
          mkdir -p release-binaries
          # Copy all binaries (exclude non-binary files)
          cd spotfi-bridge-go
          for file in spotfi-bridge-*; do
            if [ -f "$file" ] && [[ ! "$file" =~ \.(sh|md|go|mod|bat|ps1)$ ]]; then
              cp "$file" ../release-binaries/
              echo "Copied: $file"
            fi
          done
          cd ..
          # Create archive with all binaries
          cd release-binaries
          tar -czf spotfi-bridge-binaries.tar.gz spotfi-bridge-* 2>/dev/null || true
          cd ..
          echo ""
          echo "Files ready for release:"
          ls -lh release-binaries/
          echo ""
          echo "File count: $(ls -1 release-binaries/ | wc -l)"
          echo ""
          echo "Verifying required files exist:"
          REQUIRED_FILES=("spotfi-bridge-mips" "spotfi-bridge-mipsle" "spotfi-bridge-mips64" "spotfi-bridge-mips64le" "spotfi-bridge-arm64" "spotfi-bridge-arm" "spotfi-bridge-amd64" "spotfi-bridge-386" "spotfi-bridge-riscv64")
          MISSING=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "release-binaries/$file" ]; then
              echo "  ✓ $file"
            else
              echo "  ✗ $file (MISSING)"
              MISSING=$((MISSING + 1))
            fi
          done
          if [ $MISSING -gt 0 ]; then
            echo "Warning: $MISSING file(s) missing!"
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          body: |
            ## SpotFi Bridge Binaries
            
            Pre-built binaries for all supported architectures.
            
            ### Supported Architectures
            
            - **MIPS** (mips_24kc) - `spotfi-bridge-mips`
            - **MIPSLE** (mipsel_24kc) - `spotfi-bridge-mipsle`
            - **MIPS64** (64-bit MIPS) - `spotfi-bridge-mips64`
            - **MIPS64LE** (64-bit MIPS little-endian) - `spotfi-bridge-mips64le`
            - **ARM64** (aarch64) - `spotfi-bridge-arm64`
            - **ARM** (32-bit ARM) - `spotfi-bridge-arm`
            - **AMD64** (x86_64) - `spotfi-bridge-amd64`
            - **386** (32-bit x86) - `spotfi-bridge-386`
            - **RISC-V 64** - `spotfi-bridge-riscv64`
            
            ### Installation
            
            The OpenWRT setup script will automatically download the correct binary for your architecture.
            
            ```bash
            wget -O /tmp/openwrt-setup-cloud.sh https://raw.githubusercontent.com/rufaromugabe/spotfi/main/scripts/openwrt-setup-cloud.sh
            sh /tmp/openwrt-setup-cloud.sh ROUTER_ID TOKEN MAC_ADDRESS WS_URL
            ```
            
            ### Binary Sizes
            
            All binaries are compressed with UPX for optimal size:
            - Compressed: ~1.5-2MB per binary
            - Original: ~5-6MB per binary
            - Reduction: ~70% smaller
          files: |
            release-binaries/spotfi-bridge-mips
            release-binaries/spotfi-bridge-mipsle
            release-binaries/spotfi-bridge-mips64
            release-binaries/spotfi-bridge-mips64le
            release-binaries/spotfi-bridge-arm64
            release-binaries/spotfi-bridge-arm
            release-binaries/spotfi-bridge-amd64
            release-binaries/spotfi-bridge-386
            release-binaries/spotfi-bridge-riscv64
            release-binaries/spotfi-bridge-binaries.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Verify release assets
        if: always()
        run: |
          echo "Checking release assets..."
          RELEASE_TAG="${{ steps.get_version.outputs.version }}"
          ASSETS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/rufaromugabe/spotfi/releases/tags/${RELEASE_TAG}" | \
            jq -r '.assets[].name' 2>/dev/null || echo "")
          
          if [ -z "$ASSETS" ]; then
            echo "⚠ No assets found in release. Files may not have been uploaded."
            echo "Files that should be uploaded:"
            ls -1 release-binaries/ || true
          else
            echo "✓ Release assets found:"
            echo "$ASSETS"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

