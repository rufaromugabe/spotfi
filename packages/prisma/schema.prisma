generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // Connection pool optimization for production
  // Configure via DATABASE_URL: ?connection_limit=20&pool_timeout=20
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      Role     @default(HOST)
  routers   Router[]
  invoices  Invoice[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model Router {
  id           String    @id @default(cuid())
  name         String
  hostId       String
  host         User      @relation(fields: [hostId], references: [id], onDelete: Cascade)
  token        String    @unique
  radiusSecret String?   @unique  // Unique RADIUS secret for NAS authentication (optional for existing routers)
  status       RouterStatus @default(OFFLINE)
  lastSeen     DateTime?
  totalUsage   Float     @default(0)
  nasipaddress String?
  macAddress   String?   // Router MAC address for robust tracking (doesn't change like IP)
  location     String?
  invoices     Invoice[]
  sessions     RadAcct[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([hostId])
  @@index([macAddress])
  @@map("routers")
}

model Invoice {
  id          String   @id @default(cuid())
  hostId      String
  host        User     @relation(fields: [hostId], references: [id], onDelete: Cascade)
  routerId    String
  router      Router   @relation(fields: [routerId], references: [id], onDelete: Cascade)
  amount      Float
  period      DateTime
  usage       Float
  status      InvoiceStatus @default(PENDING)
  paidAt      DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([hostId])
  @@index([routerId])
  @@index([period])
  @@index([hostId, period])
  @@map("invoices")
}

// FreeRADIUS accounting table - lowercase for PostgreSQL compatibility
model RadAcct {
  radAcctId           BigInt    @id @default(autoincrement()) @map("radacctid")
  acctSessionId       String    @map("acctsessionid")
  acctUniqueId        String    @unique @map("acctuniqueid")
  userName            String?   @map("username")
  realm               String?   @map("realm")
  nasIpAddress        String    @map("nasipaddress")
  nasPortId           String?   @map("nasportid")
  nasPortType         String?   @map("nasporttype")
  acctStartTime       DateTime? @map("acctstarttime")
  acctUpdateTime      DateTime? @map("acctupdatetime")
  acctStopTime        DateTime? @map("acctstoptime")
  acctInterval        BigInt?   @map("acctinterval")
  acctSessionTime     BigInt?   @map("acctsessiontime")
  acctAuthentic       String?   @map("acctauthentic")
  connectInfoStart    String?   @map("connectinfo_start")
  connectInfoStop     String?   @map("connectinfo_stop")
  acctInputOctets     BigInt?   @map("acctinputoctets")
  acctOutputOctets    BigInt?   @map("acctoutputoctets")
  calledStationId     String?   @map("calledstationid")
  callingStationId    String?   @map("callingstationid")
  acctTerminateCause  String?   @map("acctterminatecause")
  serviceType         String?   @map("servicetype")
  framedProtocol      String?   @map("framedprotocol")
  framedIpAddress     String?   @map("framedipaddress")
  framedIpv6Address   String?   @map("framedipv6address")
  framedIpv6Prefix    String?   @map("framedipv6prefix")
  framedInterfaceId   String?   @map("framedinterfaceid")
  delegatedIpv6Prefix String?   @map("delegatedipv6prefix")
  class               String?   @map("class")
  
  // Relations to your app models
  routerId            String?
  router              Router?   @relation(fields: [routerId], references: [id])

  @@index([acctUniqueId], map: "radacct_active_session_idx")
  @@index([nasIpAddress, acctStartTime], map: "radacct_bulk_close")
  @@index([acctStartTime, userName], map: "radacct_start_user_idx")
  @@index([class], map: "radacct_calss_idx")
  @@index([routerId])
  @@map("radacct")
}

// FreeRADIUS user check attributes - lowercase for PostgreSQL compatibility
model RadCheck {
  id        Int    @id @default(autoincrement())
  userName  String @map("username") @default("")
  attribute String @map("attribute") @default("")
  op        String @default("==") @db.VarChar(2)
  value     String @map("value") @default("")

  @@unique([userName, attribute], map: "radcheck_unique")
  @@index([userName, attribute], map: "radcheck_username")
  @@map("radcheck")
}

// FreeRADIUS group check attributes - lowercase for PostgreSQL compatibility
model RadGroupCheck {
  id        Int    @id @default(autoincrement())
  groupName String @map("groupname") @default("")
  attribute String @map("attribute") @default("")
  op        String @default("==") @db.VarChar(2)
  value     String @map("value") @default("")

  @@unique([groupName, attribute], map: "radgroupcheck_unique")
  @@index([groupName, attribute], map: "radgroupcheck_groupname")
  @@map("radgroupcheck")
}

// FreeRADIUS group reply attributes - lowercase for PostgreSQL compatibility
model RadGroupReply {
  id        Int    @id @default(autoincrement())
  groupName String @map("groupname") @default("")
  attribute String @map("attribute") @default("")
  op        String @default("=") @db.VarChar(2)
  value     String @map("value") @default("")

  @@unique([groupName, attribute], map: "radgroupreply_unique")
  @@index([groupName, attribute], map: "radgroupreply_groupname")
  @@map("radgroupreply")
}

// FreeRADIUS user reply attributes - lowercase for PostgreSQL compatibility
model RadReply {
  id        Int    @id @default(autoincrement())
  userName  String @map("username") @default("")
  attribute String @map("attribute") @default("")
  op        String @default("=") @db.VarChar(2)
  value     String @map("value") @default("")

  @@unique([userName, attribute], map: "radreply_unique")
  @@index([userName, attribute], map: "radreply_username")
  @@map("radreply")
}

// FreeRADIUS user to group mapping - lowercase for PostgreSQL compatibility
model RadUserGroup {
  id        Int    @id @default(autoincrement())
  userName  String @map("username") @default("")
  groupName String @map("groupname") @default("")
  priority  Int    @default(0)

  @@unique([userName, groupName], map: "radusergroup_unique")
  @@index([userName], map: "radusergroup_username")
  @@map("radusergroup")
}

// FreeRADIUS post-authentication logging - lowercase for PostgreSQL compatibility
model RadPostAuth {
  id               BigInt   @id @default(autoincrement())
  username         String
  pass             String?
  reply            String?
  calledStationId  String?  @map("calledstationid")
  callingStationId String?  @map("callingstationid")
  authDate         DateTime @default(now()) @map("authdate")
  class            String?  @map("class")

  @@index([username], map: "radpostauth_username_idx")
  @@index([class], map: "radpostauth_class_idx")
  @@map("radpostauth")
}

// FreeRADIUS NAS (Network Access Server) clients - lowercase for PostgreSQL compatibility
model Nas {
  id          Int     @id @default(autoincrement())
  nasName     String  @unique @map("nasname")
  shortName   String  @map("shortname")
  type        String  @default("other")
  ports       Int?
  secret      String
  server      String?
  community   String?
  description String?

  @@index([nasName], map: "nas_nasname")
  @@map("nas")
}

// FreeRADIUS NAS reload tracking - lowercase for PostgreSQL compatibility
model NasReload {
  nasIpAddress String   @id @map("nasipaddress")
  reloadTime   DateTime @map("reloadtime")

  @@map("nasreload")
}

// FreeRADIUS user quota tracking - for cross-router quota management
model RadQuota {
  id          Int      @id @default(autoincrement())
  username    String   @map("username")
  quotaType   String   @default("monthly") @map("quota_type")
  maxOctets   BigInt   @map("max_octets")
  usedOctets  BigInt   @default(0) @map("used_octets")
  periodStart DateTime @map("period_start")
  periodEnd   DateTime @map("period_end")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([username, quotaType, periodStart])
  @@index([username], map: "radquota_username_idx")
  @@index([periodEnd], map: "radquota_period_idx")
  @@map("radquota")
}

enum Role {
  ADMIN
  HOST
}

enum RouterStatus {
  ONLINE
  OFFLINE
  ERROR
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

