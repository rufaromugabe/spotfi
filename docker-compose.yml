services:
  api:
    build:
      context: .
      target: runner
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-8080}
      HOST: ${HOST:-0.0.0.0}
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      DATABASE_URL: ${DATABASE_URL:?Define DATABASE_URL in your environment}
      JWT_SECRET: ${JWT_SECRET:?Define JWT_SECRET in your environment}
    ports:
      - "${PORT:-8080}:8080"
      
  emqx:
    image: emqx/emqx:5.3.0
    container_name: emqx
    ports:
      - "1883:1883"
      - "8083:8083"
      - "8084:8084"
      - "8883:8883"
      - "18083:18083"
    environment:
      EMQX_ALLOW_ANONYMOUS: "true" # For dev simplicity. Prod should use false.
      EMQX_LOADED_PLUGINS: "emqx_recon,emqx_retainer,emqx_management"
      # --- Production Authentication (Uncomment/Verify vars for Prod) ---
      EMQX_ALLOW_ANONYMOUS: "false" # Hardened for production
      EMQX_LOADED_PLUGINS: "emqx_recon,emqx_retainer,emqx_management,emqx_auth_pgsql"
      # --- Production Authentication & Authorization ---
      EMQX_AUTHENTICATION__1__MECHANISM: "password_based"
      EMQX_AUTHENTICATION__1__BACKEND: "postgresql"
      EMQX_AUTHENTICATION__1__ENABLE: "true"
      EMQX_AUTHENTICATION__1__SERVER: "postgres:5432"
      EMQX_AUTHENTICATION__1__DATABASE: "spotfi"
      EMQX_AUTHENTICATION__1__USERNAME: "postgres"
      EMQX_AUTHENTICATION__1__PASSWORD: "password"
      # Use router token as MQTT password
      EMQX_AUTHENTICATION__1__QUERY: "SELECT token as password FROM routers WHERE id = \${username}"
      EMQX_AUTHENTICATION__1__PASSWORD_HASH_ALGORITHM: "plain"
      
      # --- Authorization (ACL) Logic ---
      # Restrict routers to their own topic tree
      EMQX_AUTHORIZATION__SOURCES__1__TYPE: "postgresql"
      EMQX_AUTHORIZATION__SOURCES__1__ENABLE: "true"
      EMQX_AUTHORIZATION__SOURCES__1__SERVER: "postgres:5432"
      EMQX_AUTHORIZATION__SOURCES__1__DATABASE: "spotfi"
      EMQX_AUTHORIZATION__SOURCES__1__USERNAME: "postgres"
      EMQX_AUTHORIZATION__SOURCES__1__PASSWORD: "password"
      # ACL Query: Routers can move anything in spotfi/router/{id}/ but nowhere else
      EMQX_AUTHORIZATION__SOURCES__1__QUERY: "SELECT 'allow' as permission, 'all' as action, ARRAY['spotfi/router/' || id || '/#', 'spotfi/api/#'] as topics FROM routers WHERE id = \${username}"
    
    volumes:
      - vol-emqx-data:/opt/emqx/data

volumes:
  vol-emqx-data:
