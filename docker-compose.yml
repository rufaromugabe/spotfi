services:
  api:
    build:
      context: .
      target: runner
    env_file:
      - .env
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${PORT:-8080}
      HOST: ${HOST:-0.0.0.0}
      CORS_ORIGIN: ${CORS_ORIGIN:-*}
      DATABASE_URL: ${DATABASE_URL:?Define DATABASE_URL in your environment}
      JWT_SECRET: ${JWT_SECRET:?Define JWT_SECRET in your environment}
      MQTT_BROKER_URL: ${MQTT_BROKER_URL:-mqtt://emqx:1883}
      MQTT_USERNAME: ${MQTT_USERNAME:-}
      MQTT_PASSWORD: ${MQTT_PASSWORD:-}
    ports:
      - "${PORT:-8080}:8080"
      
  emqx:
    image: emqx/emqx:5.3.0
    container_name: emqx
    ports:
      - "1883:1883"
      - "8083:8083"
      - "8084:8084"
      - "8883:8883"
      - "18083:18083"
    environment:
      EMQX_ALLOW_ANONYMOUS: "false"
      EMQX_AUTHENTICATION__1__MECHANISM: "password_based"
      EMQX_AUTHENTICATION__1__BACKEND: "postgresql"
      EMQX_AUTHENTICATION__1__ENABLE: "true"
      EMQX_AUTHENTICATION__1__SERVER: "postgres:5432"
      EMQX_AUTHENTICATION__1__DATABASE: "spotfi"
      EMQX_AUTHENTICATION__1__USERNAME: "postgres"
      EMQX_AUTHENTICATION__1__PASSWORD: "password"
      EMQX_AUTHENTICATION__1__QUERY: "SELECT token as password FROM routers WHERE id = $${username}"
      EMQX_AUTHENTICATION__1__PASSWORD_HASH_ALGORITHM: "{name = plain}"
      
      # API User Authentication (Built-in Database)
      # This allows API users to authenticate separately from routers
      # You must create the API user via EMQX Dashboard (port 18083) or API
      # Username should match MQTT_USERNAME, password should match MQTT_PASSWORD
      EMQX_AUTHENTICATION__2__MECHANISM: "password_based"
      EMQX_AUTHENTICATION__2__BACKEND: "built_in_database"
      EMQX_AUTHENTICATION__2__ENABLE: "true"

      # --- Authorization (ACL) Logic ---
      # Restrict routers to their own topic tree, allow API users full access
      EMQX_AUTHORIZATION__SOURCES__1__TYPE: "postgresql"
      EMQX_AUTHORIZATION__SOURCES__1__ENABLE: "true"
      EMQX_AUTHORIZATION__SOURCES__1__SERVER: "postgres:5432"
      EMQX_AUTHORIZATION__SOURCES__1__DATABASE: "spotfi"
      EMQX_AUTHORIZATION__SOURCES__1__USERNAME: "postgres"
      EMQX_AUTHORIZATION__SOURCES__1__PASSWORD: "password"
      # ACL Query: 
      # - Routers get access to their own topics: spotfi/router/{id}/# and spotfi/api/#
      # - API users (username = 'api_user') get full access to all router topics
      # Note: Update 'api_user' to match your MQTT_USERNAME
      EMQX_AUTHORIZATION__SOURCES__1__QUERY: "SELECT 'allow' as permission, 'all' as action, ARRAY['spotfi/router/' || id || '/#', 'spotfi/api/#'] as topics FROM routers WHERE id = $${username} UNION ALL SELECT 'allow' as permission, 'all' as action, ARRAY['spotfi/router/+/#', 'spotfi/api/#'] as topics FROM (SELECT 1) WHERE $${username} = 'api_user'"
    
    volumes:
      - vol-emqx-data:/opt/emqx/data

volumes:
  vol-emqx-data:
